# 线程池优化

## 现象

1. 高峰期时CPU空闲率较高

2. 高峰期页错误是低峰期的三倍(soft page fault). 但是线上TLB Cache miss比率较低

3. 高峰期上下文切换和任务排队数量变多

==> 线程池调度引起TP99上升


## 优化方向

1. 线程池调度，加**work steal**
2. 加core binding，主要权衡考虑L1/L2 miss vs 核间调度时间
3. 换成无锁队列，减少锁冲突: 负优化，原因是锁粒度很小，lock-free引起的总线锁和MESI导致的伪共享反而引起了时延增高，同时原有的实现存在无锁时丢任务的情况
4. 分支预测+内存序+锁粒度优化

## Question

1. 上述现象怎么查看？
2. 分别意味着什么？


# 一些代码优化

传参：
右值场景优先选择 T&&
通用或只读场景优先选择 const T&: